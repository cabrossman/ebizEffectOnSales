
select
x.ZKEY, x.DOM_TYPE_II, x.DIVISION_NAME, x.OS_HA, x.CREDIT_BIN, X.ACCOUNT_NAME,
CASE WHEN X.ACCOUNT_NAME IN ('NCHVAC', 'KYHVAC', 'AUSTINHVAC', 'DALLASHVAC', 'METRODCHVAC', 'PHOENIXHVAC', 
'CHICAGOHVAC', 'OHIOHVAC', 'NOCALHVAC', 'LYON', 'LYONWV', 'LAHVAC', 'LYONSOUTH', 'SOCALHVAC', 'LYONNORTH', 
'FLORIDAHVAC', 'WESTERNAIR') AND x.EVER_EBIZ_CUST = 1 THEN 1 ELSE 0 END HVAC_STAND_ALONE,
CASE WHEN X.ACCOUNT_NAME IN ('LYON', 'LYONWV', 'LAHVAC', 'LYONSOUTH') AND x.EVER_EBIZ_CUST = 1 THEN 1 ELSE 0 END LYON,
x.EVER_S2S_CUST, x.EVER_FOL_CUST, x.EVER_EBIZ_CUST, X.EVER_SILVER_FEI,X.EVER_BRONZE_FEI,
x.CNT_YM, x.FEI_SLS, x.TOT_ORDERS, round(x.FEI_SLS/x.CNT_YM,2) SLS_PER_MONTH, round(x.FEI_SLS/x.TOT_ORDERS,2) AS SLS_PER_ORDER,
CASE 
  WHEN X.TOT_JERB_SLS > x.FEI_SLS THEN 100 
  WHEN X.TOT_JERB_SLS < 0 THEN 0 
  ELSE round(X.TOT_JERB_SLS/x.FEI_SLS,2)*100
END AS PCT_JOB_SLS
  FROM
  (
    SELECT FC.ZKEY, FC.DOM_TYPE_II, FC.DIVISION_NAME, FC.OS_HA, FC.ACCOUNT_NAME,
    CASE 
    WHEN TO_NUMBER(FC.CREDIT_LIMIT) < 2000 THEN 'LESS THAN 2K'
    WHEN TO_NUMBER(FC.CREDIT_LIMIT) < 15000 THEN '2K TO 15K'
    WHEN TO_NUMBER(FC.CREDIT_LIMIT) < 75000 THEN '15K TO 75K'
    ELSE 'OVER 75K'
    END CREDIT_BIN,  
    CASE WHEN MAX(TO_NUMBER(NVL(bch.FIRST_S2S_ORDER,'0'))) = 0 THEN 0 ELSE 1 END EVER_S2S_CUST,
    CASE WHEN MAX(TO_NUMBER(NVL(BCH.FIRST_ORDER,'0'))) = 0 THEN 0 ELSE 1 END EVER_FOL_CUST,
    CASE WHEN MAX(TO_NUMBER(NVL(BCH.FIRST_ORDER,'0'))) + MAX(TO_NUMBER(NVL(bch.FIRST_S2S_ORDER,'0'))) = 0 THEN 0 ELSE 1 END EVER_EBIZ_CUST,
    max(case when BCH.PRO_PLUS_ACCEPTANCE_DATE IS NOT NULL AND TO_NUMBER(NVL(BCH.FIRST_ORDER,'0')) <> 0 THEN 1 ELSE 0 END) EVER_SILVER_FEI,
    max(case when BCH.PRO_PLUS_ACCEPTANCE_DATE IS NULL AND TO_NUMBER(NVL(BCH.FIRST_ORDER,'0')) <> 0 THEN 1 ELSE 0 END) EVER_BRONZE_FEI,
    sum(COUNT(DISTINCT BCH.YEARMONTH)) over(partition by fc.zkey) CNT_YM,
    sum(SUM(BCH.NET_SALES)) over(partition by fc.zkey)  FEI_SLS,
    sum(SUM(BCH.TOTAL_ORDERS)) over(partition by fc.zkey) TOT_ORDERS,
    sum(SUM(BCH.TOTAL_LINES)) over(partition by fc.zkey) TOT_LINES,
    SUM(SUM(BCH.NET_JOB_SALES)) OVER(PARTITION BY FC.ZKEY) TOT_JERB_SLS

    FROM NORTH.BRANCH_CUSTOMER_HISTORY BCH
        JOIN (
                SELECT FC123.ACCOUNT_NAME, FC123.ACCOUNT_NAME||FC123.MAIN_CUSTOMER_NK ZKEY, MAX(fc123.DOM_TYPE_II) DOM_TYPE_II, MAX(FC123.DIVISION_NAME) DIVISION_NAME, MAX(NVL(fc123.CREDIT_LIMIT,0)) CREDIT_LIMIT, MAX(FC123.OS_HA) OS_HA, MAX(FC123.PRICE_COLUMN) PRICE_COLUMN, MAX(FC123.FRIENDLY_PROFILE) FRIENDLY 
                FROM NORTH.FERGUSON_CUSTOMERS FC123
                WHERE FC123.CUSTOMER_TYPE not in ('0_BUYING_GROUP', 'CASH', 'E_EMPLOY', 'E_ENDUSER', 'E_ETAILER', 'EMPLOYEE', 'EXPORT', 'GOVT_AGENT', 'GOVT_STATE_EDUC', 'I_MISCELL', 'INDELECTRONIC', 'INDEQUIP', 'INDMISC', 'INDTRANSPOR', 'N_OEMFABDOM', 'N_OEMFABEXP', 'N_OEMMACDOM', 'N_OEMMACEXP', 'O_EXPORTER', 'O_FARM', 'O_OTHER', 'OTHER', 'T_CHURCH', 'U_REFUSE', 'UNKNOWN')
                GROUP BY FC123.ACCOUNT_NAME, FC123.ACCOUNT_NAME||FC123.MAIN_CUSTOMER_NK
              ) FC ON FC.ZKEY = BCH.ACCOUNT_NAME||BCH.MAIN_CUSTOMER_NK
    where FC.DIVISION_NAME is not null
    AND BCH.NET_SALES > 0
    
    GROUP BY FC.ZKEY, FC.DOM_TYPE_II, FC.DIVISION_NAME, FC.OS_HA, FC.ACCOUNT_NAME,
    CASE 
    WHEN TO_NUMBER(FC.CREDIT_LIMIT) < 2000 THEN 'LESS THAN 2K'
    WHEN TO_NUMBER(FC.CREDIT_LIMIT) < 15000 THEN '2K TO 15K'
    WHEN TO_NUMBER(FC.CREDIT_LIMIT) < 75000 THEN '15K TO 75K'
    ELSE 'OVER 75K'
    END
) X
/*FILTER OUT CUSTOMERS*/
where x.CNT_YM > 5 
and x.FEI_SLS > 10000 
and x.TOT_ORDERS > 10 
and x.TOT_LINES > 50  
