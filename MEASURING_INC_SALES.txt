SELECT
X.FY, X.REGION, X.DIV, X.ACCOUNT_NAME, X.BSG, X.SLS_REP, ROUND(X.TOTAL_GROSS_FEI_SALES,0) AS TOTAL_GROSS_FEI_SALES, 
ROUND(X.NET_SALES_FROM_EBIZ_CUSTS,0) NET_SALES_FROM_EBIZ_CUSTS, X.EBIZ_CUSTS_PERYM, X.CHANNEL, X.EFFECT,
ROUND(X.NET_SALES_FROM_EBIZ_CUSTS*X.EFFECT,0) AS TOT_EBIZ_SALES_IMPACT
FROM
(
    SELECT
    --BCH.ACCOUNT_NAME||BCH.MAIN_CUSTOMER_NK AS ZKEY,
    CASE 
      WHEN TO_NUMBER(BCH.YEARMONTH) BETWEEN 201108 AND 201207 THEN 'FY12'
      WHEN TO_NUMBER(BCH.YEARMONTH) BETWEEN 201208 AND 201307 THEN 'FY13'
      WHEN TO_NUMBER(BCH.YEARMONTH) BETWEEN 201308 AND 201407 THEN 'FY14'
      WHEN TO_NUMBER(BCH.YEARMONTH) BETWEEN 201408 AND 201507 THEN 'FY15'
      WHEN TO_NUMBER(BCH.YEARMONTH) BETWEEN 201508 AND 201607 THEN 'FY16'
    END FY,
    BCH.DIVISION_NAME AS REGION,
    BCH.REGION_NAME AS DIV,
    BCH.ACCOUNT_NAME,
    CASE
      WHEN BCH.REGION_NAME = 'D60 FIRE & FABRICATION' THEN 'Fire/Fabrication' 
      WHEN BCH.REGION_NAME = 'D61 INDUSTRIAL PVF' THEN 'Industrial'
      WHEN BCH.REGION_NAME = 'D63 OEM' THEN 'Indus Other'
      WHEN BCH.REGION_NAME = 'D69 INDUSTRIAL SPECIALTY' THEN 'Indus Other'
      WHEN BCH.REGION_NAME = 'D62 INTEGRATED SERVICES' THEN 'Indus Other'
      WHEN BCH.DIVISION_NAME = 'WATERWORKS REGION' THEN 'Waterworks'
      WHEN BCH.DIVISION_NAME = 'HVAC REGION' THEN 'HVAC'
      WHEN BCH.DIVISION_NAME IN ('EAST REGION','NORTH CENTRAL REGION','SOUTH CENTRAL REGION','WEST REGION')
      THEN BG.BUSINESS_GROUP
      ELSE 'RED_ALERT_DANGER_DANGER'
    END BSG,
    BCH.CURR_ACC_NAME||'_'||BCH.SALESREP_NAME AS SLS_REP,
    SUM(BCH.NET_SALES) TOTAL_GROSS_FEI_SALES,
    SUM(CASE WHEN NVL(bch.FIRST_ORDER,999999) < bch.YEARMONTH then BCH.NET_SALES else 0 end) NET_SALES_FROM_EBIZ_CUSTS,
    sum(CASE WHEN NVL(bch.FIRST_ORDER,999999) < bch.YEARMONTH then 1 else 0 end) EBIZ_CUSTS_PERYM,
    'FOL' AS CHANNEL,
    .2157 AS EFFECT
    
    
    FROM NORTH.BRANCH_CUSTOMER_HISTORY BCH
    JOIN USER_SHARED.BG_CUSTTYPE_XREF@DWFEI BG ON BCH.CUSTOMER_TYPE = BG.CUSTOMER_TYPE
    
    WHERE BCH.NET_SALES > 0
    --AND BCH.YEARMONTH = 201512
    AND BCH.YEARMONTH >= 201108
    --and bch.FIRST_ORDER is not null
    --AND BCH.FIRST_S2S_ORDER IS NULL
    
    GROUP BY
    --BCH.ACCOUNT_NAME||BCH.MAIN_CUSTOMER_NK,
    CASE 
      WHEN TO_NUMBER(BCH.YEARMONTH) BETWEEN 201108 AND 201207 THEN 'FY12'
      WHEN TO_NUMBER(BCH.YEARMONTH) BETWEEN 201208 AND 201307 THEN 'FY13'
      WHEN TO_NUMBER(BCH.YEARMONTH) BETWEEN 201308 AND 201407 THEN 'FY14'
      WHEN TO_NUMBER(BCH.YEARMONTH) BETWEEN 201408 AND 201507 THEN 'FY15'
      WHEN TO_NUMBER(BCH.YEARMONTH) BETWEEN 201508 AND 201607 THEN 'FY16'
    END,
    BCH.DIVISION_NAME,
    BCH.REGION_NAME,
    BCH.ACCOUNT_NAME,
    CASE
      WHEN BCH.REGION_NAME = 'D60 FIRE & FABRICATION' THEN 'Fire/Fabrication' 
      WHEN BCH.REGION_NAME = 'D61 INDUSTRIAL PVF' THEN 'Industrial'
      WHEN BCH.REGION_NAME = 'D63 OEM' THEN 'Indus Other'
      WHEN BCH.REGION_NAME = 'D69 INDUSTRIAL SPECIALTY' THEN 'Indus Other'
      WHEN BCH.REGION_NAME = 'D62 INTEGRATED SERVICES' THEN 'Indus Other'
      WHEN BCH.DIVISION_NAME = 'WATERWORKS REGION' THEN 'Waterworks'
      WHEN BCH.DIVISION_NAME = 'HVAC REGION' THEN 'HVAC'
      WHEN BCH.DIVISION_NAME IN ('EAST REGION','NORTH CENTRAL REGION','SOUTH CENTRAL REGION','WEST REGION')
      THEN BG.BUSINESS_GROUP
      ELSE 'RED_ALERT_DANGER_DANGER'
    END,
    BCH.CURR_ACC_NAME||'_'||BCH.SALESREP_NAME
    
    UNION ALL
    
    SELECT
    --BCH.ACCOUNT_NAME||BCH.MAIN_CUSTOMER_NK AS ZKEY,
        CASE 
      WHEN TO_NUMBER(BCH.YEARMONTH) BETWEEN 201108 AND 201207 THEN 'FY12'
      WHEN TO_NUMBER(BCH.YEARMONTH) BETWEEN 201208 AND 201307 THEN 'FY13'
      WHEN TO_NUMBER(BCH.YEARMONTH) BETWEEN 201308 AND 201407 THEN 'FY14'
      WHEN TO_NUMBER(BCH.YEARMONTH) BETWEEN 201408 AND 201507 THEN 'FY15'
      WHEN TO_NUMBER(BCH.YEARMONTH) BETWEEN 201508 AND 201607 THEN 'FY16'
    END FY,
    BCH.DIVISION_NAME AS REGION,
    BCH.REGION_NAME AS DIV,
    BCH.ACCOUNT_NAME,
    CASE
      WHEN BCH.REGION_NAME = 'D60 FIRE & FABRICATION' THEN 'Fire/Fabrication' 
      WHEN BCH.REGION_NAME = 'D61 INDUSTRIAL PVF' THEN 'Industrial'
      WHEN BCH.REGION_NAME = 'D63 OEM' THEN 'Indus Other'
      WHEN BCH.REGION_NAME = 'D69 INDUSTRIAL SPECIALTY' THEN 'Indus Other'
      WHEN BCH.REGION_NAME = 'D62 INTEGRATED SERVICES' THEN 'Indus Other'
      WHEN BCH.DIVISION_NAME = 'WATERWORKS REGION' THEN 'Waterworks'
      WHEN BCH.DIVISION_NAME = 'HVAC REGION' THEN 'HVAC'
      WHEN BCH.DIVISION_NAME IN ('EAST REGION','NORTH CENTRAL REGION','SOUTH CENTRAL REGION','WEST REGION')
      THEN BG.BUSINESS_GROUP
      ELSE 'RED_ALERT_DANGER_DANGER'
    END BSG,
    BCH.CURR_ACC_NAME||'_'||BCH.SALESREP_NAME AS SLS_REP,
    SUM(BCH.NET_SALES) TOTAL_GROSS_FEI_SALES,
    SUM(CASE WHEN NVL(bch.FIRST_S2S_ORDER,999999) < bch.YEARMONTH then BCH.NET_SALES else 0 end) NET_SALES_FROM_EBIZ_CUSTS,
    sum(CASE WHEN NVL(bch.FIRST_S2S_ORDER,999999) < bch.YEARMONTH then 1 else 0 end) EBIZ_CUSTS_PERYM,
    'S2S' AS CHANNEL,
    .1259 AS EFFECT
    
    
    FROM NORTH.BRANCH_CUSTOMER_HISTORY BCH
    JOIN USER_SHARED.BG_CUSTTYPE_XREF@DWFEI BG ON BCH.CUSTOMER_TYPE = BG.CUSTOMER_TYPE
    
    WHERE BCH.NET_SALES > 0
    --AND BCH.YEARMONTH = 201512
    AND BCH.YEARMONTH >= 201108
    --and bch.FIRST_S2S_ORDER IS NOT NULL
    
    GROUP BY
    --BCH.ACCOUNT_NAME||BCH.MAIN_CUSTOMER_NK,
    CASE 
      WHEN TO_NUMBER(BCH.YEARMONTH) BETWEEN 201108 AND 201207 THEN 'FY12'
      WHEN TO_NUMBER(BCH.YEARMONTH) BETWEEN 201208 AND 201307 THEN 'FY13'
      WHEN TO_NUMBER(BCH.YEARMONTH) BETWEEN 201308 AND 201407 THEN 'FY14'
      WHEN TO_NUMBER(BCH.YEARMONTH) BETWEEN 201408 AND 201507 THEN 'FY15'
      WHEN TO_NUMBER(BCH.YEARMONTH) BETWEEN 201508 AND 201607 THEN 'FY16'
    END,
    BCH.DIVISION_NAME,
    BCH.REGION_NAME,
    BCH.ACCOUNT_NAME,
    CASE
      WHEN BCH.REGION_NAME = 'D60 FIRE & FABRICATION' THEN 'Fire/Fabrication' 
      WHEN BCH.REGION_NAME = 'D61 INDUSTRIAL PVF' THEN 'Industrial'
      WHEN BCH.REGION_NAME = 'D63 OEM' THEN 'Indus Other'
      WHEN BCH.REGION_NAME = 'D69 INDUSTRIAL SPECIALTY' THEN 'Indus Other'
      WHEN BCH.REGION_NAME = 'D62 INTEGRATED SERVICES' THEN 'Indus Other'
      WHEN BCH.DIVISION_NAME = 'WATERWORKS REGION' THEN 'Waterworks'
      WHEN BCH.DIVISION_NAME = 'HVAC REGION' THEN 'HVAC'
      WHEN BCH.DIVISION_NAME IN ('EAST REGION','NORTH CENTRAL REGION','SOUTH CENTRAL REGION','WEST REGION')
      THEN BG.BUSINESS_GROUP
      ELSE 'RED_ALERT_DANGER_DANGER'
    END,
    BCH.CURR_ACC_NAME||'_'||BCH.SALESREP_NAME
) X

WHERE CASE WHEN TOTAL_GROSS_FEI_SALES <= 0 AND X.NET_SALES_FROM_EBIZ_CUSTS <= 0 THEN 1 ELSE 0 END = 0
